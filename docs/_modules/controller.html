<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>controller &mdash; RT_Assignment3 February 6, 2022 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/graphviz.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> RT_Assignment3
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <!-- Local TOC -->
              <div class="local-toc"></div>
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">RT_Assignment3</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="index.html">Module code</a> &raquo;</li>
      <li>controller</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for controller</h1><div class="highlight"><pre>
<span></span><span class="ch">#! /usr/bin/env python3</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">.. module:: controller_ui</span>
<span class="sd">    :platform: Unix</span>
<span class="sd">    :synopsis: A user interface of the robot, with implemented controller logic</span>
<span class="sd">.. moduleauthor:: Ayan Mazhitov &lt;fenixkz7@gmail.com&gt;</span>

<span class="sd">ROS node that implements a user interface in the terminal. The user interface is consisted of four choices:</span>
<span class="sd"> * Robot will autonomously reach the desired x and y coordinate</span>
<span class="sd"> * Manual control of the robot</span>
<span class="sd"> * Manual control of the robot with assistive mode, to avoid crashes</span>
<span class="sd"> * Exit the interface</span>

<span class="sd">Libraries:</span>
<span class="sd">    `NumPy &lt;https://pypi.org/project/numpy/&gt;`_: Array computing for python</span>

<span class="sd">    `rospy &lt;http://wiki.ros.org/rospy&gt;`_: ROS bridge for Python</span>

<span class="sd">    `time &lt;https://docs.python.org/3/library/time.html&gt;`_: Time-related functions</span>

<span class="sd">    `termios &lt;https://docs.python.org/3/library/termios.html&gt;`_: POSIX calls for tty I/O control</span>

<span class="sd">    `sys &lt;https://docs.python.org/3/library/sys.html&gt;`_: System-specific parameters and functions</span>

<span class="sd">    `tty &lt;https://docs.python.org/3/library/tty.html&gt;`_: Terminal control functions</span>

<span class="sd">Publishes to:</span>
<span class="sd">    ``/move_base/goal`` the goal position to move the robot</span>

<span class="sd">    ``/move_base/cancel`` if the cancel call is given to cancel the previously set goal position</span>

<span class="sd">    ``/cmd_vel`` the desired robot velocities</span>

<span class="sd">Retrieve from:</span>
<span class="sd">    ``/move_base/status`` id and status of the goal position</span>

<span class="sd">    ``/move_base/feedback`` x, y position of the robot</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># Libraries that we are going to use</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">rospy</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">move_base_msgs.msg</span> <span class="k">import</span> <span class="n">MoveBaseActionFeedback</span>
<span class="kn">from</span> <span class="nn">move_base_msgs.msg</span> <span class="k">import</span> <span class="n">MoveBaseActionGoal</span>
<span class="kn">from</span> <span class="nn">geometry_msgs.msg</span> <span class="k">import</span> <span class="n">Twist</span>
<span class="kn">from</span> <span class="nn">sensor_msgs.msg</span> <span class="k">import</span> <span class="n">LaserScan</span>
<span class="kn">from</span> <span class="nn">actionlib_msgs.msg</span> <span class="k">import</span> <span class="n">GoalID</span>
<span class="kn">from</span> <span class="nn">actionlib_msgs.msg</span> <span class="k">import</span> <span class="n">GoalStatusArray</span>
<span class="kn">import</span> <span class="nn">termios</span>
<span class="kn">import</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">tty</span>
<span class="kn">from</span> <span class="nn">std_msgs.msg</span> <span class="k">import</span> <span class="n">Float32</span>

<span class="c1"># All the publishers that are used for communication and control purposes</span>
<span class="n">pub_movebase</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">Publisher</span><span class="p">(</span><span class="s2">&quot;move_base/goal&quot;</span><span class="p">,</span> <span class="n">MoveBaseActionGoal</span><span class="p">,</span> <span class="n">queue_size</span> <span class="o">=</span> <span class="mi">50</span><span class="p">)</span>
<span class="n">pub_cancel</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">Publisher</span><span class="p">(</span><span class="s2">&quot;move_base/cancel&quot;</span><span class="p">,</span> <span class="n">GoalID</span><span class="p">,</span> <span class="n">queue_size</span> <span class="o">=</span> <span class="mi">50</span><span class="p">)</span>
<span class="n">pub_vel</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">Publisher</span><span class="p">(</span><span class="s2">&quot;cmd_vel&quot;</span><span class="p">,</span> <span class="n">Twist</span><span class="p">,</span> <span class="n">queue_size</span> <span class="o">=</span> <span class="mi">50</span><span class="p">)</span>


<div class="viewcode-block" id="my_print"><a class="viewcode-back" href="../index.html#controller.my_print">[docs]</a><span class="k">def</span> <span class="nf">my_print</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot; Function to simulate a UI to give the user a set of options</span>

<span class="sd">    Args:</span>
<span class="sd">        None</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;clear&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Greetings! This is a UI for the mobile robot simulation, there are several options available, please choose one of them: &quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;1. Robot will autonomously reach the desired x and y coordinate&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;2. Manual control of the robot&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;3. Manual control of the robot with assistive mode&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;4. Exit the interface&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="first_choice"><a class="viewcode-back" href="../index.html#controller.first_choice">[docs]</a><span class="k">def</span> <span class="nf">first_choice</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot; Function to autonomously reach the desired x,y coordinate. Corresponds to the first choise of UI.</span>

<span class="sd">    Args:</span>
<span class="sd">        None</span>

<span class="sd">    Returns:</span>
<span class="sd">        int: **1** if done</span>

<span class="sd">    .. note::</span>
<span class="sd">        The completion of the goal position is checked via calculating the Euclidean distance between the goal and the</span>
<span class="sd">        actual position. The threshold is set to 0.3, but can be changed to be more accurate.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Constructing our message to sent to the /move_base topic</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="n">MoveBaseActionGoal</span><span class="p">()</span>
    <span class="n">msg</span><span class="o">.</span><span class="n">goal</span><span class="o">.</span><span class="n">target_pose</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">frame_id</span> <span class="o">=</span> <span class="s2">&quot;map&quot;</span>
    <span class="n">msg</span><span class="o">.</span><span class="n">goal</span><span class="o">.</span><span class="n">target_pose</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">orientation</span><span class="o">.</span><span class="n">w</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">done</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">dist_thresh</span> <span class="o">=</span> <span class="mf">0.3</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="n">done</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;clear&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The first option has been chosen, now please insert x and y coordinate&quot;</span><span class="p">)</span>
        <span class="n">x_goal</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">input</span><span class="p">(</span><span class="s2">&quot;x coordinate: &quot;</span><span class="p">))</span>
        <span class="n">y_goal</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">input</span><span class="p">(</span><span class="s2">&quot;y coordinate: &quot;</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The coordinates were given: x = </span><span class="si">%2.2f</span><span class="s2"> and y = </span><span class="si">%2.2f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">x_goal</span><span class="p">,</span> <span class="n">y_goal</span><span class="p">))</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">goal</span><span class="o">.</span><span class="n">target_pose</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">x_goal</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">goal</span><span class="o">.</span><span class="n">target_pose</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">y_goal</span>
        <span class="c1"># Move to the desired x and y</span>
        <span class="n">pub_movebase</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The robot starts moving&quot;</span><span class="p">)</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">Time</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">to_sec</span><span class="p">()</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">start</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="mi">100</span>
        <span class="n">status</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">while</span> <span class="n">status</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">status</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">wait_for_message</span><span class="p">(</span><span class="s2">&quot;move_base/status&quot;</span><span class="p">,</span> <span class="n">GoalStatusArray</span><span class="p">)</span>
        <span class="c1"># Retrieve the id of the goal</span>
        <span class="nb">id</span> <span class="o">=</span> <span class="n">status</span><span class="o">.</span><span class="n">status_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">goal_id</span><span class="o">.</span><span class="n">id</span>
        <span class="c1"># Retrieve the current status</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">status</span><span class="o">.</span><span class="n">status_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">status</span>

        <span class="k">while</span> <span class="n">dist</span> <span class="o">&gt;</span> <span class="n">dist_thresh</span><span class="p">:</span> <span class="c1"># We are checking the distance to see if we reached the goal</span>
            <span class="c1"># Constantly check the status of the goal position</span>
            <span class="n">status</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">wait_for_message</span><span class="p">(</span><span class="s2">&quot;move_base/status&quot;</span><span class="p">,</span> <span class="n">GoalStatusArray</span><span class="p">)</span>
            <span class="n">state</span> <span class="o">=</span> <span class="n">status</span><span class="o">.</span><span class="n">status_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">status</span>
            <span class="c1"># 1 means that the goal is active, others are that it is no longer active,</span>
            <span class="c1"># so if its no longer active we can exit the loop</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">):</span>
                <span class="k">break</span>
            <span class="n">feedback</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">wait_for_message</span><span class="p">(</span><span class="s2">&quot;move_base/feedback&quot;</span><span class="p">,</span> <span class="n">MoveBaseActionFeedback</span><span class="p">)</span>
            <span class="c1"># Get the current x position of the robot</span>
            <span class="n">x_now</span> <span class="o">=</span> <span class="n">feedback</span><span class="o">.</span><span class="n">feedback</span><span class="o">.</span><span class="n">base_position</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">x</span>
            <span class="c1"># Get the current y position of the robot</span>
            <span class="n">y_now</span> <span class="o">=</span> <span class="n">feedback</span><span class="o">.</span><span class="n">feedback</span><span class="o">.</span><span class="n">base_position</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">y</span>
            <span class="c1"># Calculate the Euclidean distance</span>
            <span class="n">dist</span> <span class="o">=</span> <span class="p">((</span><span class="n">x_goal</span> <span class="o">-</span> <span class="n">x_now</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y_goal</span> <span class="o">-</span> <span class="n">y_now</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span>
            <span class="n">now</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">Time</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">to_sec</span><span class="p">()</span>
            <span class="c1"># Print some feedback for the user</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Robot&#39;s current location: x = </span><span class="si">%2.2f</span><span class="s2"> y = </span><span class="si">%2.2f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">x_now</span><span class="p">,</span> <span class="n">y_now</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Time elapsed: </span><span class="si">%2.2f</span><span class="s2">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">start</span><span class="p">))</span>
        <span class="c1"># So, basically status can be 4 which means that there is no trajectory for the desired goal position</span>
        <span class="c1"># (Note) status can also be 2, meaning that it reached the position, but since we are calculating the distance, it does not have time to update it</span>
        <span class="c1"># So, the only case is when its 4, and we have to notify the user that the goal position is unreachable</span>
        <span class="k">if</span> <span class="n">state</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">inp</span> <span class="o">=</span> <span class="n">raw_input</span><span class="p">(</span><span class="s2">&quot;The robot cannot move to the position you indicated, would you like to cancel the current goal? yn</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">inp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">break</span>

        <span class="c1"># Successfully reached</span>
        <span class="k">if</span> <span class="n">dist</span> <span class="o">&lt;</span> <span class="n">dist_thresh</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Robot has achieved the goal position!&quot;</span><span class="p">)</span>

        <span class="c1"># Cancel the current goal, to set a new one if needed</span>
        <span class="n">msg_cancel</span> <span class="o">=</span> <span class="n">GoalID</span><span class="p">()</span>
        <span class="n">msg_cancel</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="nb">id</span>
        <span class="n">pub_cancel</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">msg_cancel</span><span class="p">)</span>
        <span class="n">inp</span> <span class="o">=</span> <span class="n">raw_input</span><span class="p">(</span><span class="s2">&quot;Do you want to enter new goal coordinates? yn</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">inp</span> <span class="o">==</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">done</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="mi">1</span></div>


<div class="viewcode-block" id="getch"><a class="viewcode-back" href="../index.html#controller.getch">[docs]</a><span class="k">def</span> <span class="nf">getch</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot; Function to get the user input without having to press enter</span>

<span class="sd">        Args:</span>
<span class="sd">            None</span>

<span class="sd">        Returns:</span>
<span class="sd">            char: A char that was given by the user.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">_getch</span><span class="p">():</span>
        <span class="n">fd</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">fileno</span><span class="p">()</span>
        <span class="n">old_settings</span> <span class="o">=</span> <span class="n">termios</span><span class="o">.</span><span class="n">tcgetattr</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">tty</span><span class="o">.</span><span class="n">setraw</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span>
            <span class="n">ch</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">termios</span><span class="o">.</span><span class="n">tcsetattr</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">termios</span><span class="o">.</span><span class="n">TCSADRAIN</span><span class="p">,</span> <span class="n">old_settings</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ch</span>
    <span class="k">return</span> <span class="n">_getch</span><span class="p">()</span></div>


<div class="viewcode-block" id="manual_drive"><a class="viewcode-back" href="../index.html#controller.manual_drive">[docs]</a><span class="k">def</span> <span class="nf">manual_drive</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot; Function that get the user input and transform it into appropriate velocities.</span>
<span class="sd">        For the second and third choice, to map the input to the appropriate output</span>

<span class="sd">        Args:</span>
<span class="sd">            None</span>

<span class="sd">        Returns:</span>
<span class="sd">            (tuple): tuple containing:</span>
<span class="sd">                * **x_vel** (double): speed along x-axis</span>

<span class="sd">                * **z_ang** (double): angular velocity around z-axis</span>

<span class="sd">                * **done** (bool): the user exitted the UI</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">key</span> <span class="o">=</span> <span class="n">getch</span><span class="p">()</span>
    <span class="n">x_vel</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">z_ang</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">done</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c1"># Forward</span>
    <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;w&#39;</span> <span class="ow">or</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;W&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
    <span class="c1"># Turn left</span>
    <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;a&#39;</span> <span class="ow">or</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;A&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span>
    <span class="c1"># Turn right</span>
    <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;d&#39;</span> <span class="ow">or</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;D&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span>
    <span class="c1"># Backward</span>
    <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;s&#39;</span> <span class="ow">or</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;S&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
    <span class="c1"># Exit</span>
    <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;e&#39;</span> <span class="ow">or</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;E&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Unknown command</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x_vel</span><span class="p">,</span> <span class="n">z_ang</span><span class="p">,</span> <span class="n">done</span></div>


<div class="viewcode-block" id="second_choice"><a class="viewcode-back" href="../index.html#controller.second_choice">[docs]</a><span class="k">def</span> <span class="nf">second_choice</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot; Function to manually control the robot</span>
<span class="sd">        Args:</span>
<span class="sd">            None</span>

<span class="sd">        Returns:</span>
<span class="sd">            int: **1** if done</span>

<span class="sd">        .. note::</span>
<span class="sd">                The function accepts the control of WASD type. Either low or upper key. Also, to constantly move</span>
<span class="sd">                the user has to push the corresponding button continuously, not only press one time.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">done</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;clear&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Well choice, Vin Diesel. Now you can manually control the robot. The list of keys are:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;W or w: to move forward&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;S or s: to move backward&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;A or a: to turn left&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;D or d: to turn right&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;E or e: to exit the manual control</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="c1"># Set the message of type Twist() to send to the corresponding topic</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="n">Twist</span><span class="p">()</span>
    <span class="n">msg</span><span class="o">.</span><span class="n">linear</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">msg</span><span class="o">.</span><span class="n">linear</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">msg</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">msg</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c1"># Infinite loop until the user decides to exit</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="n">done</span><span class="p">:</span>
        <span class="c1"># Get the desired velocity from the input</span>
        <span class="p">[</span><span class="n">msg</span><span class="o">.</span><span class="n">linear</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">msg</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="n">done</span><span class="p">]</span> <span class="o">=</span> <span class="n">manual_drive</span><span class="p">()</span>
        <span class="c1"># Publish this velocity to the /cmd_vel topic</span>
        <span class="n">pub_vel</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">linear</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># Reset the velocity, so its like in real life, the user has to constantly</span>
        <span class="c1"># push the button to move forward for example. Not only once</span>
        <span class="n">pub_vel</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="c1"># To keep it clean and accurate. These commands used to erase the last line, where user wrote his input</span>
        <span class="n">CURSOR_UP</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[F&#39;</span>
        <span class="n">ERASE_LINE</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[K&#39;</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">CURSOR_UP</span> <span class="o">+</span> <span class="n">ERASE_LINE</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">1</span></div>


<div class="viewcode-block" id="calculateMinDistance"><a class="viewcode-back" href="../index.html#controller.calculateMinDistance">[docs]</a><span class="k">def</span> <span class="nf">calculateMinDistance</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Function to calculate the minimal distance</span>
<span class="sd">        from the robot to the obstacle, from the left side, right side and from frontal side</span>

<span class="sd">        Args:</span>
<span class="sd">            data (array of doubles): array of data from laser scan.</span>

<span class="sd">        Returns:</span>
<span class="sd">            (tuple): tuple containing:</span>
<span class="sd">                * **minDistanceLeft** (double): distance to the closest obstacle on the left</span>

<span class="sd">                * **minDistanceFront** (double): distance to the closest obstacle in front</span>
<span class="sd">                * **minDistanceRight** (double): distance to the closest obstacle on the right</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">minDistanceLeft</span> <span class="o">=</span> <span class="mi">30</span>
    <span class="n">minDistanceFront</span> <span class="o">=</span> <span class="mi">30</span>
    <span class="n">minDistanceRight</span> <span class="o">=</span> <span class="mi">30</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="o">*</span><span class="mi">45</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">minDistanceLeft</span><span class="p">:</span>
            <span class="n">minDistanceLeft</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="mi">45</span><span class="p">,</span> <span class="mi">4</span><span class="o">*</span><span class="mi">135</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">minDistanceFront</span><span class="p">:</span>
            <span class="n">minDistanceFront</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="mi">135</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">minDistanceRight</span><span class="p">:</span>
            <span class="n">minDistanceRight</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">minDistanceLeft</span><span class="p">,</span> <span class="n">minDistanceFront</span><span class="p">,</span> <span class="n">minDistanceRight</span></div>

<span class="c1">#</span>
<div class="viewcode-block" id="third_choice"><a class="viewcode-back" href="../index.html#controller.third_choice">[docs]</a><span class="k">def</span> <span class="nf">third_choice</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot; Function for manual control with assistance. It allows the user to drive the robot manually, but</span>
<span class="sd">        prevents it from crashing.</span>

<span class="sd">        Args:</span>
<span class="sd">            None</span>

<span class="sd">        Returns:</span>
<span class="sd">            int: **1** if done</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">done</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c1"># Variable to set the minimal safe distance</span>
    <span class="n">safeDistance</span> <span class="o">=</span> <span class="mf">0.5</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;clear&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The third option has been chosen. Now you can manually control the robot, but the algorithm will help you not to crush into the walls. The list of keys are:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;W or w: to move forward&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;S or s: to move backward&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;A or a: to turn left&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;D or d: to turn right&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;E or e: to exit the manual control</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="c1"># Set the message of type Twist() to send to the corresponding topic</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="n">Twist</span><span class="p">()</span>
    <span class="n">msg</span><span class="o">.</span><span class="n">linear</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">msg</span><span class="o">.</span><span class="n">linear</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">msg</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">msg</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">while</span> <span class="ow">not</span> <span class="n">done</span><span class="p">:</span>
        <span class="p">[</span><span class="n">msg</span><span class="o">.</span><span class="n">linear</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">msg</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="n">done</span><span class="p">]</span> <span class="o">=</span> <span class="n">manual_drive</span><span class="p">()</span>
        <span class="n">laser</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">wait_for_message</span><span class="p">(</span><span class="s2">&quot;/scan&quot;</span><span class="p">,</span> <span class="n">LaserScan</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">laser</span><span class="o">.</span><span class="n">ranges</span>
        <span class="c1"># So, now we are calculating the minimal distance and not allowing the user to go crush</span>
        <span class="p">[</span><span class="n">minLeft</span><span class="p">,</span> <span class="n">minFront</span><span class="p">,</span> <span class="n">minRight</span><span class="p">]</span> <span class="o">=</span> <span class="n">calculateMinDistance</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="c1"># If the obstacle is on the left, front, right then it blocks the user to turn/drive</span>
        <span class="k">if</span> <span class="n">minLeft</span> <span class="o">&lt;</span> <span class="n">safeDistance</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">z</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Sorry, but you cannot move to the right, because there is an obstacle</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">minFront</span> <span class="o">&lt;</span> <span class="n">safeDistance</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">linear</span><span class="o">.</span><span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Sorry, but you cannot move to the front, because there is an obstacle</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">linear</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">minRight</span> <span class="o">&lt;</span> <span class="n">safeDistance</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">z</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Sorry, but you cannot move to the left, because there is an obstacle</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">pub_vel</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">linear</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">pub_vel</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="c1"># To keep it clean and accurate. These commands used to erase the last line, where user wrote his input</span>
        <span class="n">CURSOR_UP</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[F&#39;</span>
        <span class="n">ERASE_LINE</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[K&#39;</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">CURSOR_UP</span> <span class="o">+</span> <span class="n">ERASE_LINE</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">1</span></div>

<span class="c1"># This is the main function with the while loop to give</span>
<div class="viewcode-block" id="main"><a class="viewcode-back" href="../index.html#controller.main">[docs]</a><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot; Main function. Constantly waits for the user choice and then runs the corresponding</span>
<span class="sd">        function.</span>

<span class="sd">        Args:</span>
<span class="sd">            None</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>

<span class="sd">        .. note::</span>
<span class="sd">                The choice is has to be an integer from 1 to 4</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">done</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">rospy</span><span class="o">.</span><span class="n">init_node</span><span class="p">(</span><span class="s1">&#39;final_assignment&#39;</span><span class="p">)</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="n">rospy</span><span class="o">.</span><span class="n">is_shutdown</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">done</span><span class="p">:</span>
        <span class="n">my_print</span><span class="p">()</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">choice</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Please insert your choice: &quot;</span><span class="p">))</span>
                <span class="k">break</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Please, only integers&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">choice</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">while</span> <span class="ow">not</span> <span class="n">first_choice</span><span class="p">():</span>
                <span class="k">pass</span>
        <span class="k">if</span> <span class="n">choice</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">while</span> <span class="ow">not</span> <span class="n">second_choice</span><span class="p">():</span>
                <span class="k">pass</span>
        <span class="k">if</span> <span class="n">choice</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">while</span> <span class="ow">not</span> <span class="n">third_choice</span><span class="p">():</span>
                <span class="k">pass</span>
        <span class="k">elif</span> <span class="n">choice</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">done</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Unknown command&quot;</span><span class="p">)</span></div>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Ayan Mazhitov.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>